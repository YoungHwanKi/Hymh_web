<div th:fragment="content">
    <h2 class="memo-title">ğŸ“’ ë©”ëª¨ ë¦¬ìŠ¤íŠ¸</h2>


    <div class="search-container">
        <div class="search-title">ğŸ” ê²€ìƒ‰</div>

        <form method="get" action="/memo" class="search-form" onsubmit="return validateDateRange();">

            <!-- ê²€ìƒ‰í•­ëª© ì„ íƒ -->
            <div class="search-item">
                <label>ê²€ìƒ‰ì¡°ê±´</label>
                <select name="searchType" id="searchType" class="search-select"
                        onchange="changeSearchPlaceholder()">
                    <option value="title" th:selected="${searchType == 'title'}">ì œëª©</option>
                    <option value="writer" th:selected="${searchType == 'writer'}">ì‘ì„±ì</option>
                </select>
            </div>

            <!-- ê²€ìƒ‰ì–´ ì…ë ¥ -->
            <div class="search-item">
                <label>ê²€ìƒ‰ì–´</label>
                <input type="text" name="keyword" id="keywordInput"
                       th:value="${keyword}"
                       placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       class="search-input">
            </div>

            <!-- ë‚ ì§œ -->
            <div class="search-item">
                <label>ìµœì¢…ìˆ˜ì •ì¼</label>
                <div class="date-range">
                    <input type="date" name="startDate" th:value="${startDate}" class="date-input" id="startDate">
                    <span class="date-sep">~</span>
                    <input type="date" name="endDate" th:value="${endDate}" class="date-input" id="endDate">
                </div>
            </div>

            <button type="submit" class="search-btn">ê²€ìƒ‰</button>
            <input type="hidden" name="size" th:value="${size}">
        </form>
    </div>

    <div class="memo-btn-area">
        <a href="javascript:void(0)" class="memo-btn" onclick="openNewPopup()">+ ìƒˆ ë©”ëª¨</a>
    </div>

    <div class="count-info">
        <strong th:text="${totalCount}"></strong> ê±´ ì¡°íšŒë¨
    </div>

    <table class="memo-table">
        <thead>
        <tr>
            <th>ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th>ì‘ì„±ì</th>
            <th>ë“±ë¡ì¼</th>
            <th>ìµœì¢…ìˆ˜ì •ì¼</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="memo : ${memoList}">
            <td th:text="${memo.seq}"></td>

            <td class="title">
                <a href="javascript:void(0)"
                   th:onclick="|openPopup(${memo.seq})|">
                    <span th:text="${memo.title}"></span>
                </a>
            </td>


            <td th:text="${memo.yname}"></td>
            <td th:text="${memo.regdt}"></td>
            <td th:text="${memo.upddt}"></td>
        </tr>
        </tbody>
    </table>

    <!-- í•œ í˜ì´ì§€ì— ëª‡ ê°œì”© ë³¼ì§€ ì„ íƒ -->
    <div class="page-size-selector">
        <form id="pageSizeForm" method="get" action="/memo">
            <select name="size" onchange="document.getElementById('pageSizeForm').submit()">
                <option th:value="10" th:selected="${size == 10}">10ê°œì”© ë³´ê¸°</option>
                <option th:value="20" th:selected="${size == 20}">20ê°œì”© ë³´ê¸°</option>
                <option th:value="30" th:selected="${size == 30}">30ê°œì”© ë³´ê¸°</option>
                <option th:value="50" th:selected="${size == 50}">50ê°œì”© ë³´ê¸°</option>
            </select>

            <!-- í˜„ì¬ í˜ì´ì§€ ìœ ì§€ -->
            <input type="hidden" name="page" th:value="${currentPage}">

            <!-- ì¡°íšŒ ì¡°ê±´ ìœ ì§€ -->
            <input type="hidden" name="searchType" th:value="${searchType}">
            <input type="hidden" name="keyword" th:value="${keyword}">
            <input type="hidden" name="startDate" th:value="${startDate}">
            <input type="hidden" name="endDate" th:value="${endDate}">
        </form>
    </div>

    <!-- í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="pagination">
        <ul>

            <!-- â—€â—€ ë§¨ ì²˜ìŒ -->
            <li th:if="${currentPage > 1}">
                <a th:href="@{/memo(
        page=1,
        size=${size},
        searchType=${searchType},
        keyword=${keyword},
        startDate=${startDate},
        endDate=${endDate}
    )}">â—€â—€ ì²˜ìŒ</a>
            </li>

            <!-- â—€ ì´ì „ -->
            <li th:if="${currentPage > 1}">
                <a th:href="@{/memo(
        page=${currentPage - 1},
        size=${size},
        searchType=${searchType},
        keyword=${keyword},
        startDate=${startDate},
        endDate=${endDate}
    )}">â—€ ì´ì „</a>
            </li>

            <!-- í˜ì´ì§€ ë²ˆí˜¸ -->
            <li th:each="pageNum : ${#numbers.sequence(startPage, endPage)}"
                th:classappend="${pageNum == currentPage} ? 'active'">
                <a th:text="${pageNum}"
                   th:href="@{/memo(
           page=${pageNum},
           size=${size},
           searchType=${searchType},
           keyword=${keyword},
           startDate=${startDate},
           endDate=${endDate}
       )}"></a>
            </li>

            <!-- ë‹¤ìŒ â–¶ -->
            <li th:if="${currentPage < totalPages}">
                <a th:href="@{/memo(
        page=${currentPage + 1},
        size=${size},
        searchType=${searchType},
        keyword=${keyword},
        startDate=${startDate},
        endDate=${endDate}
    )}">ë‹¤ìŒ â–¶</a>
            </li>

            <!-- ë§ˆì§€ë§‰ â–¶â–¶ -->
            <li th:if="${currentPage < totalPages}">
                <a th:href="@{/memo(
        page=${totalPages},
        size=${size},
        searchType=${searchType},
        keyword=${keyword},
        startDate=${startDate},
        endDate=${endDate}
    )}">ë§ˆì§€ë§‰ â–¶â–¶</a>
            </li>

        </ul>
    </div>

    <script>
        // placeholder ë³€ê²½ ê¸°ëŠ¥ ìœ ì§€
        function changeSearchPlaceholder() {
            const type = document.getElementById("searchType").value;
            const input = document.getElementById("keywordInput");

            input.placeholder = type === "title" ? "ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" : "ì‘ì„±ìë¥¼ ì…ë ¥í•˜ì„¸ìš”";
        }

        // ë‚ ì§œ ë²”ìœ„ 1ë‹¬ ì œí•œ
        function validateDateRange() {
            const start = document.getElementById("startDate").value;
            const end = document.getElementById("endDate").value;

            if (start && end) {
                const s = new Date(start);
                const e = new Date(end);

                const diff = (e - s) / (1000 * 60 * 60 * 24);

                if (diff < 0) {
                    alert("ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return false;
                }
                if (diff > 31) {
                    alert("ê²€ìƒ‰ ê¸°ê°„ì€ ìµœëŒ€ 1ê°œì›”(31ì¼)ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    return false;
                }
            }
            return true;
        }

        // â­ ë‚ ì§œê°€ ë¹„ì–´ìˆìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ ì„¤ì •
        function initDateDefault() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const today = `${year}-${month}-${day}`;

            const startInput = document.getElementById("startDate");
            const endInput = document.getElementById("endDate");

            if (startInput && !startInput.value) startInput.value = today;
            if (endInput && !endInput.value) endInput.value = today;
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
        changeSearchPlaceholder();
        initDateDefault();


        // ğŸ“Œ íŒì—… ì—´ê¸°
        function openPopup(seq) {

            fetch("/memo/detail?seq=" + seq)
                .then(res => {
                    if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
                    return res.json();
                })
                .then(data => {

                    // ì½˜ì†” ë””ë²„ê¹…
                    console.log("ğŸ“Œ íŒì—… ë°ì´í„°:", data);

                    // ì œëª©
                    document.getElementById("popupTitle").innerText =
                        data.title ?? "(ì œëª© ì—†ìŒ)";

                    // ì‘ì„±ì + ìˆ˜ì •ì¼
                    document.getElementById("popupInfo").innerText =
                        (data.yname ?? "") + " | " + (data.upddt ?? "");

                    // ë‚´ìš© (memo í•„ë“œ)
                    document.getElementById("popupMemo").innerText =
                        data.memo ?? "(ë‚´ìš© ì—†ìŒ)";

                    // ìˆ˜ì • ë²„íŠ¼
                    document.getElementById("popupEditBtn").onclick = () => openEditPopup(seq);

                    // íŒì—… ì—´ê¸°
                    document.getElementById("memoPopup").style.display = "flex";
                })
                .catch(err => {
                    alert("íŒì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n" + err);
                    console.error(err);
                });
        }

        // ğŸ“Œ íŒì—… ë‹«ê¸°
        function closePopup() {
            document.getElementById("memoPopup").style.display = "none";
        }


        let currentSeq = null;

        function openEditPopup(seq) {
            currentSeq = seq;

            // ê¸°ì¡´ íŒì—… ë‹«ê¸°
            closePopup();

            // ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            fetch("/memo/detail?seq=" + seq)
                .then(res => res.json())
                .then(data => {
                    document.getElementById("editTitle").value = data.title ?? "";
                    document.getElementById("editMemo").value = data.memo ?? "";

                    document.getElementById("memoEditPopup").style.display = "flex";
                });
        }

        function updateMemo() {

            const title = document.getElementById("editTitle").value.trim();
            const memo  = document.getElementById("editMemo").value.trim();

            if (!title) {
                alert("ì œëª©ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.");
                return;
            }

            fetch("/memo/update", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    seq: currentSeq,
                    title: title,
                    memo: memo
                })
            })
                .then(res => res.text())
                .then(response => {
                    if (response === "success") {
                        alert("ğŸ“Œ ìˆ˜ì • ì™„ë£Œ!");
                        closeEditPopup();
                        location.reload();
                    } else {
                        alert("âŒ ìˆ˜ì • ì‹¤íŒ¨ (DB ê°±ì‹  ì•ˆë¨)");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("âŒ ì„œë²„ ì˜¤ë¥˜: " + err);
                });
        }

        function closeEditPopup() {
            document.getElementById("memoEditPopup").style.display = "none";
        }


        function openNewPopup() {
            document.getElementById("newTitle").value = "";
            document.getElementById("newMemo").value = "";
            document.getElementById("memoNewPopup").style.display = "flex";
        }

        function closeNewPopup() {
            document.getElementById("memoNewPopup").style.display = "none";
        }


        function insertMemo() {

            const title = document.getElementById("newTitle").value.trim();
            const memo  = document.getElementById("newMemo").value.trim();

            if (!title) {
                alert("ì œëª©ì€ í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.");
                return;
            }

            fetch("/memo/insert", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, memo })
            })
                .then(res => res.text())
                .then(result => {
                    if (result === "success") {
                        alert("ğŸ“Œ ë“±ë¡ ì™„ë£Œ!");
                        closeNewPopup();
                        location.reload();
                    } else {
                        alert("âŒ ë“±ë¡ ì‹¤íŒ¨!");
                    }
                })
                .catch(err => {
                    alert("âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ: " + err);
                });
        }

    </script>


    <!-- ======================= -->
    <!-- ğŸ“Œ ë©”ëª¨ ìƒì„¸ íŒì—… ë ˆì´ì–´ -->
    <!-- ======================= -->
    <div class="memo-popup-overlay" id="memoPopup">
        <div class="memo-popup">
            <div class="popup-header">
                <h3 id="popupTitle">ì œëª©</h3>
                <span id="popupInfo">ì‘ì„±ì | ë“±ë¡ì¼</span>
            </div>

            <div class="popup-memo" id="popupMemo">
                ë‚´ìš©ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤...
            </div>

            <div class="popup-buttons">
                <button class="popup-btn edit-btn" id="popupEditBtn">ìˆ˜ì •</button>
                <button class="popup-btn close-btn" onclick="closePopup()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>


    <!-- ======================= -->
    <!-- âœï¸ ìˆ˜ì •ìš© íŒì—… ë ˆì´ì–´ -->
    <!-- ======================= -->
    <div class="memo-edit-popup-overlay" id="memoEditPopup">
        <div class="memo-edit-popup">

            <h3>ë©”ëª¨ ìˆ˜ì •</h3>

            <label>ì œëª©</label>
            <input type="text" id="editTitle" class="edit-input">

            <label>ë‚´ìš©</label>
            <textarea id="editMemo" class="edit-textarea"></textarea>

            <div class="edit-buttons">
                <button class="popup-btn save-btn" onclick="updateMemo()">ì €ì¥</button>
                <button class="popup-btn close-btn" onclick="closeEditPopup()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!-- ğŸ†• ì‹ ê·œ ë“±ë¡ íŒì—… -->
    <!-- ======================= -->
    <div class="memo-new-popup-overlay" id="memoNewPopup">
        <div class="memo-edit-popup">
            <h3>ìƒˆ ë©”ëª¨ ì‘ì„±</h3>

            <label>ì œëª©</label>
            <input type="text" id="newTitle" class="edit-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">

            <label>ë‚´ìš©</label>
            <textarea id="newMemo" class="edit-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>

            <div class="edit-buttons">
                <button class="popup-btn save-btn" onclick="insertMemo()">ë“±ë¡</button>
                <button class="popup-btn close-btn" onclick="closeNewPopup()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

</div>

